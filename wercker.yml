box: alpine:latest

build:
  steps:
    - script:
        name: install nodejs
        code: apk add --update --no-cache nodejs
    - script:
        name: export variables
        code: |
          export DOCKER_IMAGE_NAME="$(node -p "require('./package.json').docker.name")"
          export DOCKER_IMAGE_TAG="$(node -p "require('./package.json').docker.tag")"
          echo $DOCKER_IMAGE_NAME:$DOCKER_IMAGE_TAG
    - internal/docker-build:
        dockerfile: Dockerfile
        image-name: $DOCKER_IMAGE_NAME
    - internal/docker-push:
        image-name: $DOCKER_IMAGE_NAME
        username: $DOCKERHUB_USERNAME
        password: $DOCKERHUB_PASSWORD
        repository: $DOCKERHUB_USERNAME/$DOCKER_IMAGE_NAME
        tag: $DOCKER_IMAGE_TAG
        
test:
  steps:
    - internal/docker-build:
        dockerfile: Dockerfile
        image-name: test
